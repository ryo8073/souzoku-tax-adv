# 配偶者税額軽減計算 - Gherkinユーザーストーリー

## 概要

本ドキュメントは、相続税計算アプリにおける配偶者税額軽減の計算機能に関するユーザーストーリーをGherkin形式で記述したものです。配偶者税額軽減は、配偶者が相続した財産に対する相続税について、1億6千万円または配偶者の法定相続分相当額のいずれか多い金額まで税額が軽減される制度です。

## 配偶者税額軽減の基本ルール

1. **軽減限度額**: 1億6千万円 または 配偶者の法定相続分相当額のいずれか多い金額
2. **適用条件**: 配偶者が実際に相続した財産に対してのみ適用
3. **計算方法**: 配偶者が相続した財産額に対応する税額から軽減額を控除

---

## Feature: 配偶者税額軽減計算

### Background:
```
Given 相続税計算アプリが起動している
And ユーザーが実際の分割画面にいる
```

---

## Scenario 1: 課税対象総額3億3千万円、配偶者2億円相続のケース

### 基本情報
- **課税対象総額**: 330,000,000円
- **家族構成**: 配偶者あり、子ども3人
- **配偶者相続額**: 200,000,000円
- **法定相続分**: 配偶者1/2（165,000,000円）

```gherkin
Scenario: 課税対象総額3億3千万円で配偶者が2億円相続する場合の配偶者税額軽減
  Given 課税対象総額が "330000000" 円である
  And 配偶者が存在する
  And 子どもが "3" 人いる
  And 養子はいない
  And 親は両方死亡している
  And 兄弟姉妹はいない
  And 法定相続人以外はいない
  
  When 相続税を計算する
  Then 法定相続人数は "4" 人である
  And 基礎控除額は "78000000" 円である
  And 課税遺産総額は "252000000" 円である
  And 配偶者の法定相続分は "165000000" 円である
  And 子ども1人あたりの法定相続分は "55000000" 円である
  
  When 実際の分割で配偶者が "200000000" 円相続する
  And 子ども1が "43333333" 円相続する
  And 子ども2が "43333333" 円相続する
  And 子ども3が "43333334" 円相続する
  
  Then 配偶者の相続税額（軽減前）は "25600000" 円である
  And 配偶者の軽減限度額は "200000000" 円である
  # 軽減限度額 = max(160000000, 165000000) = 165000000円
  # ただし実際の相続額200000000円まで軽減可能
  And 配偶者の軽減税額は "25600000" 円である
  And 配偶者の納付税額は "0" 円である
  And 子ども1の納付税額は "5533333" 円である
  And 子ども2の納付税額は "5533333" 円である
  And 子ども3の納付税額は "5533334" 円である
  And 総納付税額は "16600000" 円である
```

---

## Scenario 2: 課税対象総額2億円、配偶者1億6千万円相続のケース

```gherkin
Scenario: 課税対象総額2億円で配偶者が1億6千万円相続する場合の配偶者税額軽減
  Given 課税対象総額が "200000000" 円である
  And 配偶者が存在する
  And 子どもが "2" 人いる
  And 養子はいない
  And 親は両方死亡している
  And 兄弟姉妹はいない
  And 法定相続人以外はいない
  
  When 相続税を計算する
  Then 法定相続人数は "3" 人である
  And 基礎控除額は "48000000" 円である
  And 課税遺産総額は "152000000" 円である
  And 配偶者の法定相続分は "100000000" 円である
  And 子ども1人あたりの法定相続分は "50000000" 円である
  
  When 実際の分割で配偶者が "160000000" 円相続する
  And 子ども1が "20000000" 円相続する
  And 子ども2が "20000000" 円相続する
  
  Then 配偶者の相続税額（軽減前）は "19200000" 円である
  And 配偶者の軽減限度額は "160000000" 円である
  # 軽減限度額 = max(160000000, 100000000) = 160000000円
  And 配偶者の軽減税額は "19200000" 円である
  And 配偶者の納付税額は "0" 円である
  And 子ども1の納付税額は "2400000" 円である
  And 子ども2の納付税額は "2400000" 円である
  And 総納付税額は "4800000" 円である
```

---

## Scenario 3: 課税対象総額4億円、配偶者3億円相続のケース

```gherkin
Scenario: 課税対象総額4億円で配偶者が3億円相続する場合の配偶者税額軽減
  Given 課税対象総額が "400000000" 円である
  And 配偶者が存在する
  And 子どもが "2" 人いる
  And 養子はいない
  And 親は両方死亡している
  And 兄弟姉妹はいない
  And 法定相続人以外はいない
  
  When 相続税を計算する
  Then 法定相続人数は "3" 人である
  And 基礎控除額は "48000000" 円である
  And 課税遺産総額は "352000000" 円である
  And 配偶者の法定相続分は "200000000" 円である
  And 子ども1人あたりの法定相続分は "100000000" 円である
  
  When 実際の分割で配偶者が "300000000" 円相続する
  And 子ども1が "50000000" 円相続する
  And 子ども2が "50000000" 円相続する
  
  Then 配偶者の相続税額（軽減前）は "81600000" 円である
  And 配偶者の軽減限度額は "200000000" 円である
  # 軽減限度額 = max(160000000, 200000000) = 200000000円
  # ただし実際の相続額300000000円のうち200000000円まで軽減
  And 配偶者の軽減税額は "54400000" 円である
  And 配偶者の納付税額は "27200000" 円である
  And 子ども1の納付税額は "13600000" 円である
  And 子ども2の納付税額は "13600000" 円である
  And 総納付税額は "54400000" 円である
```

---

## Scenario 4: 課税対象総額1億円、配偶者全額相続のケース

```gherkin
Scenario: 課税対象総額1億円で配偶者が全額相続する場合の配偶者税額軽減
  Given 課税対象総額が "100000000" 円である
  And 配偶者が存在する
  And 子どもが "1" 人いる
  And 養子はいない
  And 親は両方死亡している
  And 兄弟姉妹はいない
  And 法定相続人以外はいない
  
  When 相続税を計算する
  Then 法定相続人数は "2" 人である
  And 基礎控除額は "42000000" 円である
  And 課税遺産総額は "58000000" 円である
  And 配偶者の法定相続分は "50000000" 円である
  And 子どもの法定相続分は "50000000" 円である
  
  When 実際の分割で配偶者が "100000000" 円相続する
  And 子どもが "0" 円相続する
  
  Then 配偶者の相続税額（軽減前）は "11600000" 円である
  And 配偶者の軽減限度額は "160000000" 円である
  # 軽減限度額 = max(160000000, 50000000) = 160000000円
  And 配偶者の軽減税額は "11600000" 円である
  And 配偶者の納付税額は "0" 円である
  And 子どもの納付税額は "0" 円である
  And 総納付税額は "0" 円である
```

---

## Scenario 5: 課税対象総額5億円、配偶者1億6千万円のみ相続のケース

```gherkin
Scenario: 課税対象総額5億円で配偶者が1億6千万円のみ相続する場合の配偶者税額軽減
  Given 課税対象総額が "500000000" 円である
  And 配偶者が存在する
  And 子どもが "3" 人いる
  And 養子はいない
  And 親は両方死亡している
  And 兄弟姉妹はいない
  And 法定相続人以外はいない
  
  When 相続税を計算する
  Then 法定相続人数は "4" 人である
  And 基礎控除額は "78000000" 円である
  And 課税遺産総額は "422000000" 円である
  And 配偶者の法定相続分は "250000000" 円である
  And 子ども1人あたりの法定相続分は "83333333" 円である
  
  When 実際の分割で配偶者が "160000000" 円相続する
  And 子ども1が "113333333" 円相続する
  And 子ども2が "113333333" 円相続する
  And 子ども3が "113333334" 円相続する
  
  Then 配偶者の相続税額（軽減前）は "24320000" 円である
  And 配偶者の軽減限度額は "160000000" 円である
  # 軽減限度額 = max(160000000, 250000000) = 250000000円
  # ただし実際の相続額160000000円まで軽減
  And 配偶者の軽減税額は "24320000" 円である
  And 配偶者の納付税額は "0" 円である
  And 子ども1の納付税額は "17226666" 円である
  And 子ども2の納付税額は "17226666" 円である
  And 子ども3の納付税額は "17226668" 円である
  And 総納付税額は "51680000" 円である
```

---

## Scenario 6: 配偶者なし、子どものみのケース（軽減なし）

```gherkin
Scenario: 配偶者がいない場合の相続税計算（軽減制度適用なし）
  Given 課税対象総額が "300000000" 円である
  And 配偶者が存在しない
  And 子どもが "2" 人いる
  And 養子はいない
  And 親は両方死亡している
  And 兄弟姉妹はいない
  And 法定相続人以外はいない
  
  When 相続税を計算する
  Then 法定相続人数は "2" 人である
  And 基礎控除額は "42000000" 円である
  And 課税遺産総額は "258000000" 円である
  And 子ども1人あたりの法定相続分は "150000000" 円である
  
  When 実際の分割で子ども1が "150000000" 円相続する
  And 子ども2が "150000000" 円相続する
  
  Then 配偶者税額軽減は適用されない
  And 子ども1の納付税額は "23100000" 円である
  And 子ども2の納付税額は "23100000" 円である
  And 総納付税額は "46200000" 円である
```

---

## Scenario 7: 配偶者と親のみのケース

```gherkin
Scenario: 配偶者と親のみが相続人の場合の配偶者税額軽減
  Given 課税対象総額が "250000000" 円である
  And 配偶者が存在する
  And 子どもがいない
  And 養子はいない
  And 親が "1" 人存命している
  And 兄弟姉妹はいない
  And 法定相続人以外はいない
  
  When 相続税を計算する
  Then 法定相続人数は "2" 人である
  And 基礎控除額は "42000000" 円である
  And 課税遺産総額は "208000000" 円である
  And 配偶者の法定相続分は "166666667" 円である
  # 配偶者2/3、親1/3
  And 親の法定相続分は "83333333" 円である
  
  When 実際の分割で配偶者が "200000000" 円相続する
  And 親が "50000000" 円相続する
  
  Then 配偶者の相続税額（軽減前）は "33600000" 円である
  And 配偶者の軽減限度額は "166666667" 円である
  # 軽減限度額 = max(160000000, 166666667) = 166666667円
  And 配偶者の軽減税額は "28000000" 円である
  And 配偶者の納付税額は "5600000" 円である
  And 親の納付税額は "8400000" 円である
  And 総納付税額は "14000000" 円である
```

---

## Scenario 8: 配偶者と兄弟姉妹のケース

```gherkin
Scenario: 配偶者と兄弟姉妹が相続人の場合の配偶者税額軽減
  Given 課税対象総額が "180000000" 円である
  And 配偶者が存在する
  And 子どもがいない
  And 養子はいない
  And 親は両方死亡している
  And 全血兄弟姉妹が "2" 人いる
  And 半血兄弟姉妹はいない
  And 法定相続人以外はいない
  
  When 相続税を計算する
  Then 法定相続人数は "3" 人である
  And 基礎控除額は "48000000" 円である
  And 課税遺産総額は "132000000" 円である
  And 配偶者の法定相続分は "135000000" 円である
  # 配偶者3/4、兄弟姉妹1/4
  And 兄弟姉妹1人あたりの法定相続分は "22500000" 円である
  
  When 実際の分割で配偶者が "150000000" 円相続する
  And 兄弟姉妹1が "15000000" 円相続する
  And 兄弟姉妹2が "15000000" 円相続する
  
  Then 配偶者の相続税額（軽減前）は "18000000" 円である
  And 配偶者の軽減限度額は "160000000" 円である
  # 軽減限度額 = max(160000000, 135000000) = 160000000円
  And 配偶者の軽減税額は "18000000" 円である
  And 配偶者の納付税額は "0" 円である
  And 兄弟姉妹1の納付税額は "2160000" 円である
  # 兄弟姉妹は2割加算適用
  And 兄弟姉妹2の納付税額は "2160000" 円である
  And 総納付税額は "4320000" 円である
```

---

## Scenario 9: 法定相続人以外が相続するケース

```gherkin
Scenario: 法定相続人以外が相続する場合の配偶者税額軽減と2割加算
  Given 課税対象総額が "280000000" 円である
  And 配偶者が存在する
  And 子どもが "1" 人いる
  And 養子はいない
  And 親は両方死亡している
  And 兄弟姉妹はいない
  And 法定相続人以外が "1" 人いる
  
  When 相続税を計算する
  Then 法定相続人数は "2" 人である
  And 基礎控除額は "42000000" 円である
  And 課税遺産総額は "238000000" 円である
  And 配偶者の法定相続分は "140000000" 円である
  And 子どもの法定相続分は "140000000" 円である
  
  When 実際の分割で配偶者が "180000000" 円相続する
  And 子どもが "50000000" 円相続する
  And 法定相続人以外が "50000000" 円相続する
  
  Then 配偶者の相続税額（軽減前）は "35700000" 円である
  And 配偶者の軽減限度額は "160000000" 円である
  # 軽減限度額 = max(160000000, 140000000) = 160000000円
  And 配偶者の軽減税額は "35700000" 円である
  And 配偶者の納付税額は "0" 円である
  And 子どもの納付税額は "9925000" 円である
  And 法定相続人以外の納付税額は "11910000" 円である
  # 法定相続人以外は2割加算適用: 9925000 × 1.2 = 11910000
  And 総納付税額は "21835000" 円である
```

---

## Scenario 10: 端数処理のテストケース

```gherkin
Scenario: 端数が発生する分割での配偶者税額軽減計算
  Given 課税対象総額が "333333333" 円である
  And 配偶者が存在する
  And 子どもが "3" 人いる
  And 養子はいない
  And 親は両方死亡している
  And 兄弟姉妹はいない
  And 法定相続人以外はいない
  
  When 相続税を計算する
  Then 法定相続人数は "4" 人である
  And 基礎控除額は "78000000" 円である
  And 課税遺産総額は "255333333" 円である
  And 配偶者の法定相続分は "166666667" 円である
  And 子ども1人あたりの法定相続分は "55555556" 円である
  
  When 実際の分割で配偶者が "166666667" 円相続する
  And 子ども1が "55555555" 円相続する
  And 子ども2が "55555555" 円相続する
  And 子ども3が "55555556" 円相続する
  
  Then 配偶者の相続税額（軽減前）は "21333333" 円である
  And 配偶者の軽減限度額は "166666667" 円である
  # 軽減限度額 = max(160000000, 166666667) = 166666667円
  And 配偶者の軽減税額は "21333333" 円である
  And 配偶者の納付税額は "0" 円である
  And 子ども1の納付税額は "7111111" 円である
  And 子ども2の納付税額は "7111111" 円である
  And 子ども3の納付税額は "7111112" 円である
  And 総納付税額は "21333334" 円である
```

---

## 計算ロジックの検証ポイント

### 1. 軽減限度額の計算
- 1億6千万円と法定相続分相当額の比較
- より多い金額が軽減限度額となる

### 2. 軽減税額の計算
- 配偶者の実際の相続額に対応する税額
- 軽減限度額を超える部分は軽減対象外

### 3. 端数処理
- 相続分の端数処理
- 税額計算の端数処理

### 4. 2割加算との関係
- 配偶者には2割加算は適用されない
- 法定相続人以外には2割加算が適用される

---

## 期待される動作

1. **正確な軽減限度額計算**: 1億6千万円と法定相続分の比較
2. **適切な軽減税額計算**: 実際の相続額に基づく軽減
3. **端数処理の一貫性**: 計算過程での適切な端数処理
4. **他の制度との連携**: 2割加算等との適切な組み合わせ

このユーザーストーリーにより、配偶者税額軽減機能の包括的なテストが可能となります。

